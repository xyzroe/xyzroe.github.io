<!doctype html><html lang=en-us><head><title>Alco Post / xyzroe's blog</title><link rel="shortcut icon" href=../../favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.101.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="xyzroe"><meta name=description content><link rel=stylesheet href=//xyzroe.cc/css/main.min.e936c5013d179081bc7d200f84dcfe9c246ba63f93f7d53028d5ba8329bb286c.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-203059197-1","auto"),ga("send","pageview"))</script><meta name=twitter:card content="summary"><meta name=twitter:title content="Alco Post"><meta name=twitter:description content="Hardware and software complex of the checkpoint 1 turnstile any 2 controllers ZK MA300 2 alcotesters Alcofor S40 1 speaker and LED unit with voice prompts and mode indication 1 orange pi with python utility for displaying photos and status of passing through the turnstile and writing to the database order of actions: authorization to ZK - alcohol test - in case of an error again - in case of an error, again record the violation and refusal to work (or notification of dismissal, but with permission to exit) - record a successful passage and farewell."><meta property="og:title" content="Alco Post"><meta property="og:description" content="Hardware and software complex of the checkpoint 1 turnstile any 2 controllers ZK MA300 2 alcotesters Alcofor S40 1 speaker and LED unit with voice prompts and mode indication 1 orange pi with python utility for displaying photos and status of passing through the turnstile and writing to the database order of actions: authorization to ZK - alcohol test - in case of an error again - in case of an error, again record the violation and refusal to work (or notification of dismissal, but with permission to exit) - record a successful passage and farewell."><meta property="og:type" content="article"><meta property="og:url" content="//xyzroe.cc/posts/alcopost/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-15T00:00:00+00:00"><meta property="article:modified_time" content="2018-05-15T00:00:00+00:00"><script src=https://unpkg.com/feather-icons></script>
<link rel=stylesheet href=../../css/google-translate.css><script src=https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js></script>
<script src=../../js/google-translate.js></script>
<link rel=stylesheet href=../../css/accordion.css></head><body><header class=app-header><div class=notranslate><a href=//xyzroe.cc/><img class=app-header-avatar src=../../img/avatar.png alt=xyzroe></a><h1></h1><nav class=app-header-menu><a class=app-header-menu-item href=../../>Home</a>
-
<a class=app-header-menu-item href=../../tags/>Tags</a>
-
<a class=app-header-menu-item href=../../about/>About</a></nav><p>Technical automation, project management, analytics and process optimization</p><div class=app-header-social><a href=https://t.me/xyzroe target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-send"><title>Telergam</title><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></a><a href=mailto:xyzroe@mind.in.ua target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-at-sign"><title>Email</title><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg></a><a href=https://github.com/xyzroe target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div><div class=app-footer>&copy; 2020<script>(new Date).getFullYear()>2010&&document.write(" - "+(new Date).getFullYear())</script></div><div class=app-footer><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-sa/4.0/88x31.png></a></div><div class=language><a href=# alt=EN data-google-lang=en class=language__img>🇬🇧</a>
<a href=# alt=UA data-google-lang=uk class=language__img>🇺🇦</a>
<a href=# alt=PL data-google-lang=pl class=language__img>🇵🇱</a>
<a href=# alt=IL data-google-lang=iw class=language__img>🇮🇱</a>
<a href=# alt=DE data-google-lang=de class=language__img>🇩🇪</a>
<a href=# alt=FR data-google-lang=fr class=language__img>🇫🇷</a>
<a href=# alt=ES data-google-lang=es class=language__img>🇪🇸</a>
<a href=# alt=IT data-google-lang=it class=language__img>🇮🇹</a>
<a href=# alt=NL data-google-lang=nl class=language__img>🇳🇱</a>
<a href=# alt=ZH data-google-lang=zh-CN class=language__img>🇨🇳</a>
<img src=../../img/ru.png alt=ru data-google-lang=ru class=language__img height=10></div><div class=logoUA><img src="https://hb.imgix.net/1d02f65fc7f24fa11d82ba5747e386e783c87530.png?auto=compress,format&s=3020347e51662edd8c783c505a015098" height=40></div></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Alco Post</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>May 15, 2018</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>9 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=//xyzroe.cc/tags/linux/>Linux</a>
<a class=tag href=//xyzroe.cc/tags/python/>Python</a>
<a class=tag href=//xyzroe.cc/tags/arduino/>Arduino</a></div></div></header><div class=post-content><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin=anonymous><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><h2 id=hardware-and-software-complex-of-the-checkpoint>Hardware and software complex of the checkpoint</h2><ul><li>1 turnstile any</li><li>2 controllers ZK MA300</li><li>2 alcotesters Alcofor S40</li><li>1 speaker and LED unit with voice prompts and mode indication</li><li>1 orange pi with python utility for displaying photos and status of passing through the turnstile and writing to the database</li></ul><p>order of actions: authorization to ZK - alcohol test - in case of an error again - in case of an error, again record the violation and refusal to work (or notification of dismissal, but with permission to exit) - record a successful passage and farewell.</p><link rel=stylesheet href=../../css/hugo-easy-gallery.css><div class="gallery caption-position-bottom caption-effect-slide hover-effect-zoom hover-transition" itemscope itemtype=http://schema.org/ImageGallery><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/buttons.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/buttons.jpg alt=Buttons></div><figcaption><p>Buttons</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/buttons.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/general.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/general.jpg alt=General></div><figcaption><p>General</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/general.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/inside_1.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/inside_1.jpg alt="Inside 1"></div><figcaption><p>Inside 1</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/inside_1.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/inside_2.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/inside_2.jpg alt="Inside 2"></div><figcaption><p>Inside 2</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/inside_2.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/inside_3.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/inside_3.jpg alt="Inside 3"></div><figcaption><p>Inside 3</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/inside_3.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/inside_4.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/inside_4.jpg alt="Inside 4"></div><figcaption><p>Inside 4</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/inside_4.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/inside_5.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/inside_5.jpg alt="Inside 5"></div><figcaption><p>Inside 5</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/inside_5.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/nvrs.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/nvrs.jpg alt=Nvrs></div><figcaption><p>Nvrs</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/nvrs.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/screen.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/screen.jpg alt=Screen></div><figcaption><p>Screen</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/screen.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/table.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/table.jpg alt=Table></div><figcaption><p>Table</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/table.jpg itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(//xyzroe.cc/posts/alcopost/photos/turnstile.jpg)><img itemprop=thumbnail src=//xyzroe.cc/posts/alcopost/photos/turnstile.jpg alt=Turnstile></div><figcaption><p>Turnstile</p></figcaption><a href=//xyzroe.cc/posts/alcopost/photos/turnstile.jpg itemprop=contentUrl></a></figure></div></div><script type=text/javascript src=//xyzroe.cc/js/pdf-js/build/pdf.js></script><style>#the-canvas{border:1px solid #000;direction:ltr;width:100%;height:auto}#paginator{text-align:center;margin-bottom:10px}</style><div id=paginator><button id=prev>Previous</button>
<button id=next>Next</button>
&nbsp; &nbsp;
<span>Page: <span id=page_num></span> / <span id=page_count></span></span></div><div id=embed-pdf-container><canvas id=the-canvas></canvas></div><script type=text/javascript>window.onload=function(){c="//xyzroe.cc/posts/alcopost/alcopost.pdf",r="true",s=window["pdfjs-dist/build/pdf"],s.GlobalWorkerOptions.workerSrc="//xyzroe.cc//js/pdf-js/build/pdf.worker.js";var s,r,c,n=null,e=1,o=!1,t=null,d=3,a=document.getElementById("the-canvas"),u=a.getContext("2d");function i(e){o=!0,n.getPage(e).then(function(e){var s,r,n=e.getViewport({scale:d});a.height=n.height,a.width=n.width,s={canvasContext:u,viewport:n},r=e.render(s),r.promise.then(function(){o=!1,t!==null&&(i(t),t=null)})}),document.getElementById("page_num").textContent=e}function l(e){o?t=e:i(e)}r=="true"&&(document.getElementById("paginator").style.display="none");function h(){if(e<=1)return;e--,l(e)}document.getElementById("prev").addEventListener("click",h);function m(){if(e>=n.numPages)return;e++,l(e)}document.getElementById("next").addEventListener("click",m),s.getDocument(c).promise.then(function(t){n=t,document.getElementById("page_count").textContent=n.numPages,i(e)})}</script><p><a href=OrangePi.zip>OrangePi Alco Post utility</a>
<a href=OrangePi.zip target=_blank><i data-feather=download stroke-width=2 width=32 height=32 color=#6f0 style=position:relative;top:10px></i>
<span class=screen-reader-text></span></a></p><p><a href=Arduino/Wiegand-V3-Library-for-all-Arduino.zip>Wiegand-V3-Library-for-all-Arduino.zip</a>
<a href=Arduino/Wiegand-V3-Library-for-all-Arduino.zip target=_blank><i data-feather=download stroke-width=2 width=32 height=32 color=#6f0 style=position:relative;top:10px></i>
<span class=screen-reader-text></span></a></p><div class=tab><input type=checkbox id=chckc7622c8a75cd1202c304088af804b80f class=input_inv>
<label class=tab-label for=chckc7622c8a75cd1202c304088af804b80f>Arduino code
<a href=../../posts/alcopost/Arduino/bio_alco_ctr_v2.ino target=_blank style=position:absolute;right:80px;color:#fff;height:25px><i data-feather=download stroke-width=1.75 width=25 height=25 style=position:relative;right:-35%></i></a></label><div class=tab-content><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Wiegand.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;ButtonDebounce.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>//#include &lt;avr/wdt.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;DFPlayer_Mini_Mp3.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define FALSE 0
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TRUE  1
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ENTER 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define EXIT  2
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ON    1
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define OFF   0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//Input Pins
</span></span></span><span style=display:flex><span><span style=color:#75715e>//uln2804 - 1 - 0,1,2,3,4
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define EnterZK         23
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define EnterAlcoOK     25
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define EnterAlcoAL     27
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define EnterAlcoRD     29
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define EnterAlcoOn     31
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//#define TurnReady       33
</span></span></span><span style=display:flex><span><span style=color:#75715e>//#define TurnReady       35
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//uln2804 - 2 - 0,1,2,3
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define ExitZK          62
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ExitAlcoOK      63
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ExitAlcoAL      64
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ExitAlcoRD      65
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ExitAlcoOn      66
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//Output Pins
</span></span></span><span style=display:flex><span><span style=color:#75715e>//uln2803 - 1 - 0,1,2,3,4,5,6
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define EnterLedGo      39
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define EnterLedStop    41
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define EnterAlcoRun    43
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ExitLedGo       45
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ExitLedStop     47
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ExitAlcoRun     49
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TurnEnter       51
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TurnExit        53
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define Vorota          59
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DoorStreet      60
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define AlcoAlarm       61
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//Times setup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define LockOpenTime    2000
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define AlarmOnTime     700
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ResetStageTime  15</span><span style=color:#75715e>//seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define AlcoStartTime   500
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define AlcoWaitMaxTime 5 </span><span style=color:#75715e>//seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//DFPlayer setup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define busyDFpin       7
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define mp3volume       25
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define soundStartAgain 1 </span><span style=color:#75715e>//Начните с начала.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define soundAlcoHowTo  2 </span><span style=color:#75715e>//Сделайте вдох, дождитесь зеленого индикатора, выдохните в прозрачную трубку.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define soundEnterOK    3 </span><span style=color:#75715e>//Спасибо! Хорошей Вам смены!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define soundExitOK     4 </span><span style=color:#75715e>//Спасибо! Хорошего Вам отдыха!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define soundError      5 </span><span style=color:#75715e>//Ошибка!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define soundNextTry    6 </span><span style=color:#75715e>//Попробуйте еще раз!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define soundEnterAlarm 7 </span><span style=color:#75715e>//Вы пришли на работу в алкогольном опьянении, и на работу не допущены.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define soundExitAlarm  8 </span><span style=color:#75715e>//Вы употребляли алкоголь на работе, и за это вас оштрафуют. В следующий раз вы будете уволены!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define soundGo         9 </span><span style=color:#75715e>//Проходите пожалуйста
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>enterZK</span>(EnterZK, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>enterAlcoOK</span>(EnterAlcoOK, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>enterAlcoAL</span>(EnterAlcoAL, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>enterAlcoRD</span>(EnterAlcoRD, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>enterAlcoOn</span>(EnterAlcoOn, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>exitZK</span>(ExitZK, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>exitAlcoOK</span>(ExitAlcoOK, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>exitAlcoAL</span>(ExitAlcoAL, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>exitAlcoRD</span>(ExitAlcoRD, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>ButtonDebounce <span style=color:#a6e22e>exitAlcoOn</span>(ExitAlcoOn, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ButtonDebounce turnReady(TurnReady, 100);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//unsigned long previousMillis = 0;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> currentMillis <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> lastOpenEnter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> lastOpenExit <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> lastOpenStreet <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> lastOpenVorota <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> cycles <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> cycles_Enter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> cycles_Exit <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> lastEnterEmp <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> lastExitEmp <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> enterEnable;
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> exitEnable;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WIEGAND wg;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> byte numChars <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> receivedChars[numChars]; <span style=color:#75715e>// an array to store the received data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>boolean newData <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> taskPC[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> dirPC <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> recvChar;
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> endMarker <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&gt;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>//Serial begin
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Serial.begin(<span style=color:#ae81ff>9600</span>);
</span></span><span style=display:flex><span>  Serial.println(F(<span style=color:#e6db74>&#34;Fingerprints Alcometers Turnstile Controler v0.5a&#34;</span>));
</span></span><span style=display:flex><span>  Serial.println(F(<span style=color:#e6db74>&#34;start boot&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//Initialised output pins
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  pinMode(EnterLedGo, OUTPUT); digitalWrite(EnterLedGo, LOW);
</span></span><span style=display:flex><span>  pinMode(TurnEnter, OUTPUT); digitalWrite(TurnEnter, LOW);
</span></span><span style=display:flex><span>  pinMode(EnterAlcoRun, OUTPUT); digitalWrite(EnterAlcoRun, LOW);
</span></span><span style=display:flex><span>  pinMode(ExitLedGo, OUTPUT); digitalWrite(ExitLedGo, LOW);
</span></span><span style=display:flex><span>  pinMode(TurnExit, OUTPUT); digitalWrite(TurnExit, LOW);
</span></span><span style=display:flex><span>  pinMode(ExitAlcoRun, OUTPUT); digitalWrite(ExitAlcoRun, LOW);
</span></span><span style=display:flex><span>  pinMode(AlcoAlarm, OUTPUT); digitalWrite(AlcoAlarm, LOW);
</span></span><span style=display:flex><span>  pinMode(DoorStreet, OUTPUT); digitalWrite(DoorStreet, LOW);
</span></span><span style=display:flex><span>  <span style=color:#75715e>//Watchdog enable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//wdt_enable(WDTO_8S);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//Wiegand reades config and start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  wg.D0PinA <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>  wg.D1PinA <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>  wg.D0PinB <span style=color:#f92672>=</span> <span style=color:#ae81ff>19</span>;
</span></span><span style=display:flex><span>  wg.D1PinB <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  wg.begin(TRUE, TRUE);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//DFPlayer-mini mp3 module config and start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Serial3.begin(<span style=color:#ae81ff>9600</span>);
</span></span><span style=display:flex><span>  pinMode(busyDFpin, INPUT);
</span></span><span style=display:flex><span>  mp3_set_serial (Serial3);
</span></span><span style=display:flex><span>  mp3_set_volume (mp3volume);
</span></span><span style=display:flex><span>  delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//Serial for Orange PI
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Serial2.begin(<span style=color:#ae81ff>9600</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//Start AlcoMeter Enter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  cycles <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  enterAlcoOn.update();
</span></span><span style=display:flex><span>  delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (enterAlcoOn.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    AlcoOnOff(ON, ENTER);
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>    enterAlcoOn.update();
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  enterAlcoRD.update();
</span></span><span style=display:flex><span>  delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (enterAlcoOn.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (enterAlcoRD.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) cycles<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (enterAlcoRD.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> cycles <span style=color:#f92672>&lt;</span> AlcoWaitMaxTime <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>)  {
</span></span><span style=display:flex><span>      enterAlcoRD.update();
</span></span><span style=display:flex><span>      delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>      cycles<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (cycles <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> cycles <span style=color:#f92672>&lt;</span> AlcoWaitMaxTime <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span> ) {
</span></span><span style=display:flex><span>      AlcoOnOff(OFF, ENTER);
</span></span><span style=display:flex><span>      delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>      enterAlcoRD.update();
</span></span><span style=display:flex><span>      enterAlcoOn.update();
</span></span><span style=display:flex><span>      delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (enterAlcoOn.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> enterAlcoRD.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        Serial.println(F(<span style=color:#e6db74>&#34;enable enter alco&#34;</span>));
</span></span><span style=display:flex><span>        enterEnable <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#75715e>//= 1;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        Serial.println(F(<span style=color:#e6db74>&#34;disable enter alco&#34;</span>));
</span></span><span style=display:flex><span>        enterEnable <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      Serial.println(F(<span style=color:#e6db74>&#34;disable enter alco&#34;</span>));
</span></span><span style=display:flex><span>      enterEnable <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (enterEnable <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>//if error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    digitalWrite(EnterLedStop, HIGH); delay(<span style=color:#ae81ff>250</span>); digitalWrite(EnterLedStop, LOW); delay(<span style=color:#ae81ff>250</span>); digitalWrite(EnterLedStop, HIGH); delay(<span style=color:#ae81ff>250</span>); digitalWrite(EnterLedStop, LOW); delay(<span style=color:#ae81ff>250</span>); digitalWrite(EnterLedStop, HIGH); delay(<span style=color:#ae81ff>250</span>); digitalWrite(EnterLedStop, LOW);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//Start AlcoMeter Exit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  cycles <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  exitAlcoOn.update();
</span></span><span style=display:flex><span>  delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (exitAlcoOn.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    AlcoOnOff(ON, EXIT);
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>    exitAlcoOn.update();
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  exitAlcoRD.update();
</span></span><span style=display:flex><span>  delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (exitAlcoOn.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (exitAlcoRD.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) cycles<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (exitAlcoRD.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> cycles <span style=color:#f92672>&lt;</span> AlcoWaitMaxTime <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>)  {
</span></span><span style=display:flex><span>      exitAlcoRD.update();
</span></span><span style=display:flex><span>      delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>      cycles<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (cycles <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> cycles <span style=color:#f92672>&lt;</span> AlcoWaitMaxTime <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span> ) {
</span></span><span style=display:flex><span>      AlcoOnOff(OFF, EXIT);
</span></span><span style=display:flex><span>      delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>      exitAlcoRD.update();
</span></span><span style=display:flex><span>      exitAlcoOn.update();
</span></span><span style=display:flex><span>      delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (exitAlcoOn.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> exitAlcoRD.state() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        Serial.println(F(<span style=color:#e6db74>&#34;enable exit alco&#34;</span>));
</span></span><span style=display:flex><span>        exitEnable <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#75715e>//= 1;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        Serial.println(F(<span style=color:#e6db74>&#34;disable exit alco&#34;</span>));
</span></span><span style=display:flex><span>        exitEnable <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      Serial.println(F(<span style=color:#e6db74>&#34;disable exit alco&#34;</span>));
</span></span><span style=display:flex><span>      exitEnable <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (exitEnable <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>//if error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    digitalWrite(ExitLedStop, HIGH); delay(<span style=color:#ae81ff>250</span>); digitalWrite(ExitLedStop, LOW); delay(<span style=color:#ae81ff>250</span>); digitalWrite(ExitLedStop, HIGH); delay(<span style=color:#ae81ff>250</span>); digitalWrite(ExitLedStop, LOW); delay(<span style=color:#ae81ff>250</span>); digitalWrite(ExitLedStop, HIGH); delay(<span style=color:#ae81ff>250</span>); digitalWrite(ExitLedStop, LOW);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  Serial.println(F(<span style=color:#e6db74>&#34;boot finish&#34;</span>));
</span></span><span style=display:flex><span>  cycles <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loop</span>() {
</span></span><span style=display:flex><span>  currentMillis <span style=color:#f92672>=</span> millis();
</span></span><span style=display:flex><span>  wiegandCheck();
</span></span><span style=display:flex><span>  checkEnter();
</span></span><span style=display:flex><span>  checkExit();
</span></span><span style=display:flex><span>  checkLocks();
</span></span><span style=display:flex><span>  recvWithEndMarker();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wiegandCheck</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (wg.available())
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    Serial.print(F(<span style=color:#e6db74>&#34;s| Emp = &#34;</span>)); Serial.print(wg.getCode()); Serial.print(F(<span style=color:#e6db74>&#34; gate = &#34;</span>)); Serial.println(wg.getGateActive());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (wg.getGateActive() <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      lastEnterEmp <span style=color:#f92672>=</span> wg.getCode();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (wg.getGateActive() <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      lastExitEmp <span style=color:#f92672>=</span> wg.getCode();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>checkEnter</span>() {
</span></span><span style=display:flex><span>  enterZK.update();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (enterStage) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (enterZK.state() <span style=color:#f92672>==</span> LOW <span style=color:#f92672>&amp;&amp;</span> lastEnterEmp <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        printStage(ENTER);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (enterEnable <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>          digitalWrite(EnterLedGo, HIGH);
</span></span><span style=display:flex><span>          mp3_play (soundAlcoHowTo); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>          AlcoOnOff(ON, ENTER);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          mp3_play (soundEnterOK); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>          enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>          printStage(ENTER);
</span></span><span style=display:flex><span>          digitalWrite(TurnEnter, HIGH); lastOpenEnter <span style=color:#f92672>=</span> currentMillis;
</span></span><span style=display:flex><span>          Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Enter On&#34;</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      enterAlcoOn.update();
</span></span><span style=display:flex><span>      enterAlcoOK.update();
</span></span><span style=display:flex><span>      enterAlcoAL.update();
</span></span><span style=display:flex><span>      delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (enterAlcoOK.state() <span style=color:#f92672>==</span> HIGH <span style=color:#f92672>&amp;&amp;</span> enterAlcoAL.state() <span style=color:#f92672>==</span> HIGH <span style=color:#f92672>&amp;&amp;</span> cycles_Enter <span style=color:#f92672>&lt;</span> ResetStageTime <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span> ) {
</span></span><span style=display:flex><span>        delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        cycles_Enter<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (enterAlcoOK.state() <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>        cycles_Enter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        mp3_play (soundEnterOK); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>        enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>        printStage(ENTER);
</span></span><span style=display:flex><span>        digitalWrite(TurnEnter, HIGH); lastOpenEnter <span style=color:#f92672>=</span> currentMillis;
</span></span><span style=display:flex><span>        Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Enter On&#34;</span>));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (enterAlcoOK.state() <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>          enterAlcoOK.update();
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (enterAlcoAL.state() <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>        cycles_Enter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        mp3_play (soundError); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>        digitalWrite(EnterLedStop, HIGH);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (digitalRead(busyDFpin) <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        digitalWrite(EnterLedStop, LOW);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//enterStage = enterStage + 1;//вторая попытка
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>; <span style=color:#75715e>//переходим сразу к сообщению об алкоголизме enterStage = 4; //переходим сразу к сообщению об алкоголизме
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (enterStage <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>) printStage(ENTER);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (enterAlcoAL.state() <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>          enterAlcoAL.update();
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (cycles_Enter <span style=color:#f92672>&gt;=</span> ResetStageTime <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>) {
</span></span><span style=display:flex><span>        cycles_Enter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        Serial.println(<span style=color:#e6db74>&#34;s| time out while enter alco test&#34;</span>);
</span></span><span style=display:flex><span>        mp3_play (soundError); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (digitalRead(busyDFpin) <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        mp3_play (soundStartAgain); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>        enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      mp3_play (soundNextTry); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>      enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>      printStage(ENTER);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      digitalWrite(EnterLedStop, HIGH);
</span></span><span style=display:flex><span>      digitalWrite(AlcoAlarm, HIGH); delay(AlarmOnTime); digitalWrite(AlcoAlarm, LOW);
</span></span><span style=display:flex><span>      mp3_play (soundEnterAlarm); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>      enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>5</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      lastEnterEmp <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (enterEnable <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        digitalWrite(EnterLedGo, LOW);
</span></span><span style=display:flex><span>        digitalWrite(EnterLedStop, LOW);
</span></span><span style=display:flex><span>        AlcoOnOff(OFF, ENTER);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      Serial.println(F(<span style=color:#e6db74>&#34;s| finish entering&#34;</span>));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>checkExit</span>() {
</span></span><span style=display:flex><span>  exitZK.update();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (exitStage) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (exitZK.state() <span style=color:#f92672>==</span> LOW <span style=color:#f92672>&amp;&amp;</span> lastExitEmp <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        printStage(EXIT);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (exitEnable <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>          digitalWrite(ExitLedGo, HIGH);
</span></span><span style=display:flex><span>          mp3_play (soundAlcoHowTo); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>          AlcoOnOff(ON, EXIT);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          mp3_play (soundExitOK); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>          exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>          printStage(EXIT);
</span></span><span style=display:flex><span>          digitalWrite(TurnExit, HIGH); lastOpenExit <span style=color:#f92672>=</span> currentMillis;
</span></span><span style=display:flex><span>          Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Exit On&#34;</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Serial.println(&#34;s| case 1 3&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      exitAlcoOn.update();
</span></span><span style=display:flex><span>      exitAlcoOK.update();
</span></span><span style=display:flex><span>      exitAlcoAL.update();
</span></span><span style=display:flex><span>      delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (exitAlcoOK.state() <span style=color:#f92672>==</span> HIGH <span style=color:#f92672>&amp;&amp;</span> exitAlcoAL.state() <span style=color:#f92672>==</span> HIGH <span style=color:#f92672>&amp;&amp;</span> cycles_Exit <span style=color:#f92672>&lt;</span> ResetStageTime <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span> ) {
</span></span><span style=display:flex><span>        delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        cycles_Exit<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (exitAlcoOK.state() <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>        cycles_Exit <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        mp3_play (soundExitOK); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>        exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>        printStage(EXIT);
</span></span><span style=display:flex><span>        digitalWrite(TurnExit, HIGH); lastOpenExit <span style=color:#f92672>=</span> currentMillis;
</span></span><span style=display:flex><span>        Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Exit On&#34;</span>));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (exitAlcoOK.state() <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>          exitAlcoOK.update();
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (exitAlcoAL.state() <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>        cycles_Exit <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        mp3_play (soundError); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>        digitalWrite(ExitLedStop, HIGH);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (digitalRead(busyDFpin) <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        digitalWrite(ExitLedStop, LOW);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//exitStage = exitStage + 1;//вторая попытка
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>; <span style=color:#75715e>//переходим сразу к сообщению об алкоголизме
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (exitStage <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>) printStage(EXIT);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (exitAlcoAL.state() <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>          exitAlcoAL.update();
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (cycles_Exit <span style=color:#f92672>&gt;=</span> ResetStageTime <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>) {
</span></span><span style=display:flex><span>        cycles_Exit <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        Serial.println(<span style=color:#e6db74>&#34;s| time out while exit alco test&#34;</span>);
</span></span><span style=display:flex><span>        mp3_play (soundError); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (digitalRead(busyDFpin) <span style=color:#f92672>==</span> LOW) {
</span></span><span style=display:flex><span>          delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        mp3_play (soundStartAgain); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>        exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      mp3_play (soundNextTry); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>      exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>      printStage(EXIT);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      digitalWrite(ExitLedStop, HIGH);
</span></span><span style=display:flex><span>      digitalWrite(AlcoAlarm, HIGH); delay(AlarmOnTime); digitalWrite(AlcoAlarm, LOW);
</span></span><span style=display:flex><span>      mp3_play (soundExitAlarm); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>      exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>5</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      lastExitEmp <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (exitEnable <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        digitalWrite(ExitLedGo, LOW);
</span></span><span style=display:flex><span>        digitalWrite(ExitLedStop, LOW);
</span></span><span style=display:flex><span>        AlcoOnOff(OFF, EXIT);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      Serial.println(F(<span style=color:#e6db74>&#34;s| finish exiting&#34;</span>));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>checkLocks</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (lastOpenEnter <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> (currentMillis <span style=color:#f92672>-</span> lastOpenEnter) <span style=color:#f92672>&gt;=</span> LockOpenTime) {
</span></span><span style=display:flex><span>    digitalWrite(TurnEnter, LOW);
</span></span><span style=display:flex><span>    lastOpenEnter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Enter Off&#34;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (lastOpenExit <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> (currentMillis <span style=color:#f92672>-</span> lastOpenExit) <span style=color:#f92672>&gt;=</span> LockOpenTime) {
</span></span><span style=display:flex><span>    digitalWrite(TurnExit, LOW);
</span></span><span style=display:flex><span>    lastOpenExit <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Exit Off&#34;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (lastOpenStreet <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> (currentMillis <span style=color:#f92672>-</span> lastOpenStreet) <span style=color:#f92672>&gt;=</span> LockOpenTime) {
</span></span><span style=display:flex><span>    digitalWrite(DoorStreet, LOW);
</span></span><span style=display:flex><span>    lastOpenStreet <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Street Off&#34;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (lastOpenVorota <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> (currentMillis <span style=color:#f92672>-</span> lastOpenVorota) <span style=color:#f92672>&gt;=</span> LockOpenTime) {
</span></span><span style=display:flex><span>    digitalWrite(Vorota, LOW);
</span></span><span style=display:flex><span>    lastOpenVorota <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Vorota Off&#34;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>AlcoOnOff</span>(<span style=color:#66d9ef>int</span> State, <span style=color:#66d9ef>int</span> Gate) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (Gate <span style=color:#f92672>==</span> ENTER) {
</span></span><span style=display:flex><span>    enterAlcoOn.update();
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (enterAlcoOn.state() <span style=color:#f92672>!=</span> State) {
</span></span><span style=display:flex><span>      digitalWrite(EnterAlcoRun, HIGH); delay(AlcoStartTime); digitalWrite(EnterAlcoRun, LOW);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (State <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) Serial.println(F(<span style=color:#e6db74>&#34;s| Alco Enter Off&#34;</span>));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (State <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) Serial.println(F(<span style=color:#e6db74>&#34;s| Alco Enter On&#34;</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (Gate <span style=color:#f92672>==</span> EXIT) {
</span></span><span style=display:flex><span>    exitAlcoOn.update();
</span></span><span style=display:flex><span>    delay(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (exitAlcoOn.state() <span style=color:#f92672>!=</span> State) {
</span></span><span style=display:flex><span>      digitalWrite(ExitAlcoRun, HIGH); delay(AlcoStartTime); digitalWrite(ExitAlcoRun, LOW);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (State <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) Serial.println(F(<span style=color:#e6db74>&#34;s| Alco Exit Off&#34;</span>));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (State <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) Serial.println(F(<span style=color:#e6db74>&#34;s| Alco Exit On&#34;</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printStage</span>(<span style=color:#66d9ef>int</span> Gate) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (Gate <span style=color:#f92672>==</span> ENTER) {
</span></span><span style=display:flex><span>    Serial2.print(F(<span style=color:#e6db74>&#34;ENTER|&#34;</span>)); Serial2.print(lastEnterEmp); Serial2.print(F(<span style=color:#e6db74>&#34;|&#34;</span>)); Serial2.println(enterStage);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (Gate <span style=color:#f92672>==</span> EXIT) {
</span></span><span style=display:flex><span>    Serial2.print(F(<span style=color:#e6db74>&#34;EXIT|&#34;</span>)); Serial2.print(lastExitEmp); Serial2.print(F(<span style=color:#e6db74>&#34;|&#34;</span>)); Serial2.println(exitStage);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>recvWithEndMarker</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> byte ndx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> endMarker <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> rc;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (Serial2.available() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> newData <span style=color:#f92672>==</span> false) {
</span></span><span style=display:flex><span>    rc <span style=color:#f92672>=</span> Serial2.read();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (rc <span style=color:#f92672>!=</span> endMarker) {
</span></span><span style=display:flex><span>      receivedChars[ndx] <span style=color:#f92672>=</span> rc;
</span></span><span style=display:flex><span>      ndx<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (ndx <span style=color:#f92672>&gt;=</span> numChars) {
</span></span><span style=display:flex><span>        ndx <span style=color:#f92672>=</span> numChars <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      receivedChars[ndx] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>; <span style=color:#75715e>// terminate the string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      ndx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      newData <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>      parseData();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>parseData</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> strtokIndx; <span style=color:#75715e>// this is used by strtok() as an index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  strtokIndx <span style=color:#f92672>=</span> strtok(receivedChars, <span style=color:#e6db74>&#34;|&#34;</span>); <span style=color:#75715e>// get the first part - the string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  strcpy(taskPC, strtokIndx); <span style=color:#75715e>// copy it to taskPC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Serial.println(taskPC);
</span></span><span style=display:flex><span>  strtokIndx <span style=color:#f92672>=</span> strtok(NULL, <span style=color:#e6db74>&#34;|&#34;</span>); <span style=color:#75715e>// this continues where the previous call left off
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  dirPC <span style=color:#f92672>=</span> atoi(strtokIndx); <span style=color:#75715e>// convert this part to an integer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Serial.println(dirPC);
</span></span><span style=display:flex><span>  showParsedData();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>showParsedData</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (taskPC[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;O&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (dirPC) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          digitalWrite(TurnEnter, HIGH); lastOpenEnter <span style=color:#f92672>=</span> currentMillis;
</span></span><span style=display:flex><span>          mp3_play (soundGo); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>          Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Enter On&#34;</span>));
</span></span><span style=display:flex><span>          enterStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          digitalWrite(TurnExit, HIGH); lastOpenExit <span style=color:#f92672>=</span> currentMillis;
</span></span><span style=display:flex><span>          mp3_play (soundGo); delay(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>          Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Exit On&#34;</span>));
</span></span><span style=display:flex><span>          exitStage <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          digitalWrite(DoorStreet, HIGH); lastOpenStreet <span style=color:#f92672>=</span> currentMillis;
</span></span><span style=display:flex><span>          Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Street On&#34;</span>));
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          digitalWrite(Vorota, HIGH); lastOpenVorota <span style=color:#f92672>=</span> currentMillis;
</span></span><span style=display:flex><span>          Serial.println(F(<span style=color:#e6db74>&#34;s| Turn Vorota On&#34;</span>));
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  newData <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div><div class=post-footer></div></article></main><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=../../js/load-photoswipe.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin=anonymous></script>
<script>feather.replace()</script></body></html>